riot.tag2("query-condition",'<div class="query-condition" if="{layout.length>0}"> <form method="get" action="{opts.url}"> <input type="hidden" name="limit" riot-value="{parent.limit}"></input> <div each="{row, i in layout}" show="{i==0 || show}" class="{condition-row:true, condition-row-more:i>0}"> <div each="{field in row}" class="condition-cell"> <span class="condition-label {nomore:i==0 &&!show}" riot-style="min-width:{!show?0:labelWidth}px">{fields[this.field].label || field}</span> <input-field field="{fields[field]}" data="{data}" type="{fields[this.field].type || \'str\'}" options="{(opts.fields_options && opts.fields_options[this.field.name]) || {}}" riot-style="min-width:{field.width || inputWidth}px"> </input-field> </div> <div if="{i==0 && !show}" class="condition-cell condition-buttons"> <button class="btn btn-primary btn-flat" type="submit"><i class="fa fa-search"></i> {searchTitle}</button> <button class="btn btn-link btn-flat" type="button" onclick="{parent.reset}">{clearTitle}</button> </div> </div> <div class="condition-row condition-row-more condition-buttons" show="{show}"> <button class="btn btn-primary btn-flat" type="submit"><i class="fa fa-search"></i> {searchTitle}</button> <button class="btn btn-link btn-flat" type="button" onclick="{reset}">{clearTitle}</button> </div> <div if="{layout.length > 1}" class="{condition-more:true, visible:layout.length>1, hover:hover}"> <span href="#" onclick="{click}" onmouseenter="{mouseenter}" onmouseleave="{mouseleave}"> {show? moreTitle[0] : moreTitle[1]} <i class="{fa:true, fa-angle-up:show, fa-angle-down:!show}"></i> </span> </div> </form> </div>','query-condition .query-condition,[data-is="query-condition"] .query-condition{ margin-bottom:5px; background-color: white; padding: 5px; } query-condition .condition-row,[data-is="query-condition"] .condition-row{ margin-top: 5px; margin-bottom: 5px; padding-top: 5px; } query-condition .condition-row-more,[data-is="query-condition"] .condition-row-more{ border-top: 1px solid #ddd; } query-condition .condition-row:last-child,[data-is="query-condition"] .condition-row:last-child{ border-bottom: none; } query-condition .condition-label,[data-is="query-condition"] .condition-label{ margin-left:8px; margin-right:8px; display: inline-block; text-align: right; } query-condition .condition-label.nomore,[data-is="query-condition"] .condition-label.nomore{ min-width: 0px; } query-condition .condition-cell,[data-is="query-condition"] .condition-cell{ display: inline-block; } query-condition .condition-more,[data-is="query-condition"] .condition-more{ text-align: center; margin-top: 5px; margin-bottom: 10px; position: relative; height: 18px; line-height: 18px; } query-condition .condition-more.visible,[data-is="query-condition"] .condition-more.visible{ border-top:1px solid #ddd; } query-condition .condition-more.visible.hover,[data-is="query-condition"] .condition-more.visible.hover{ border-top:1px solid red; } query-condition .condition-more span,[data-is="query-condition"] .condition-more span{ position: absolute; left:0; right:0; top:-1px; width:100px; border: 1px solid #ddd; border-top: 1px solid white; margin: 0 auto; cursor: pointer; font-size: 80%; background-color: white; line-height: 22px; height:22px; } query-condition .condition-more span:hover,[data-is="query-condition"] .condition-more span:hover{ border: 1px solid red; border-top: 1px solid white; } query-condition .form-control,[data-is="query-condition"] .form-control{ display:inline-block; vertical-align: middle; } query-condition input-field,[data-is="query-condition"] input-field{ display:inline-block; } query-condition .condition-row.condition-row-more.condition-buttons,[data-is="query-condition"] .condition-row.condition-row-more.condition-buttons{ text-align: center; margin-right: 5px; } query-condition .condition-row.condition-row-more.condition-buttons button,[data-is="query-condition"] .condition-row.condition-row-more.condition-buttons button{ margin-right: 5px; } query-condition .multiselect-container li input[type="radio"],[data-is="query-condition"] .multiselect-container li input[type="radio"]{margin-left:-200px;}',"",function(t){var e=this;this.layout=t.layout,this.fields={},this.labelWidth=t.labelWidth||100,this.inputWidth=t.inputWidth||200,this.searchTitle=t.searchTitle||"查询",this.clearTitle=t.clearTitle||"清除条件",this.moreTitle=t.moreTitle||["收起","更多条件"],this.ajax=t.ajax,this.url=t.url,t.fields.forEach(function(i){e.fields[i.name]=i,t.field_options&&t.field_options[i.name]&&(e.fields[i.name].options=t.field_options[i.name]),"select"==i.type&&(i.placeholder=i.placeholder||"--- 请选择 ---"),i._width=i.width?i.width+"px":i.range?"auto":"100%"}),this.show=!1,e.hover=!1;var i=new QueryString(this.url);if(this.data=$.extend({},i.urlParams,t.data),!this.layout){this.layout=[];var o=[];this.layout.push(o);for(k in this.fields)o.push(k)}this.click=function(t){e.show=!e.show},this.mouseenter=function(t){e.hover=!0},this.mouseleave=function(t){e.hover=!1},this.reset=function(t){for(k in e.fields){var i=e.fields[k];"select"==i.type&&i["data-url"]?$("[name="+k+"]",e.root).val("").trigger("change"):"select"==i.type?$("[name="+k+"]",e.root).multiselect("deselectAll",!1).multiselect("updateButtonText"):$("[name="+k+"]",e.root).val(null)}},this.on("mount",function(){e.ajax&&$(e.root).on("click",":submit",function(t){t.preventDefault();var i=serializeObject(e.root),o=get_url(e.url,i);e.parent.page=1,e.parent.load(o)})})}),riot.tag2("input-field",'<input type="text" name="{opts.field.name}" class="form-control" field-type="str" if="{opts.type==\'str\' || opts.type==\'unicode\' || opts.type==\'int\'}" placeholder="{get_placeholder(opts.field.placeholder, 0)}" riot-style="width:{opts.field._width}"> <input type="password" name="{opts.field.name}" class="form-control" field-type="password" if="{opts.type==\'password\'}" placeholder="{opts.field.placeholder}" riot-style="width:{opts.field._width}"> <select multiple="{opts.field.multiple}" if="{opts.type==\'select\'}" field-type="select" riot-style="width:{opts.field._width}" name="{opts.field.name}" data-url="{opts.field[\'data-url\']}" placeholder="{opts.field.placeholder}"> <option if="{opts.field.placeholder && !opts.field.multiple}" value="">{opts.field.placeholder}</option> <option each="{value in opts.field.choices}" riot-value="{value[0]}"> {value[1]} </option> </select> <input type="text" name="{opts.field.name}" class="form-control" field-type="{opts.type}" if="{(opts.type==\'date\' || opts.type==\'datetime\')}" placeholder="{get_placeholder(opts.field.placeholder, 0)}" riot-style="width:{opts.field._width}"> {⁗-⁗: opts.field.range} <input type="text" name="{opts.field.name}" class="form-control" field-type="{opts.type}" if="{(opts.type==\'date\' || opts.type==\'datetime\' || opts.type==\'str\' || opts.type==\'unicode\' || opts.type==\'int\') && opts.field.range==true}" placeholder="{get_placeholder(opts.field.placeholder, 1)}" riot-style="width:{opts.field._width}">',"","",function(t){var e=this;this.on("mount",function(){var i={previousMonth:"上个月",nextMonth:"下个月",months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],weekdays:["周日","周一","周二","周三","周四","周五","周六"],weekdaysShort:["日","一","二","三","四","五","六"]};if("select"==t.type&&t.field["data-url"])load("ui.select2",function(){var i=$.extend({},{width:"resolve"},t.field.options),o=$("[name="+t.field.name+"]",e.root);simple_select2(o,i)});else if("select"==t.type){var o=$.extend({},{includeSelectAllOption:!0,selectAllText:"全选",allSelectedText:"全部选中",nSelectedText:"个已选",buttonClass:"btn btn-default btn-flat",numberDisplayed:2,selectedClass:"",nonSelectedText:t.field.placeholder||"请选择",maxHeight:200},t.field.options);if(t.field.relate_from)if(t.field.choices_url){var n=[],l=$($('[name="'+t.field.name+'"]')[0]);"string"==typeof t.field.relate_from?n.push(t.field.relate_from):"object"==typeof t.field.relate_from&&(n=t.field.relate_from);for(var a=n.length,d=0;d<a;d++)$("body").on("change",'[name="'+n[d]+'"]',function(){for(var i=[],o=0;o<a;o++){var d=$("[name="+n[o]+"]").val();d&&"object"==typeof d?d=d.length>=2?d.join(","):1==d.length?d[0]:"-1":void 0!==d&&null!==d&&""+d||(d="-1"),i.push(d)}var r=i.join("/");$.ajax({method:"post",url:t.field.choices_url+"/"+r,async:!1,success:function(i){t.field.choices=i,e.update(),$.fn.multiselect&&l.multiselect("rebuild")}})});$.each(n,function(){$("[name="+this+"]").trigger("change")})}else{var r=t.field.relate_from,s=$($('[name="'+r+'"]')[0]),l=$($('[name="'+t.field.name+'"]')[0]),c=t.field.relationship,p=t.field.choices;$("body").on("change",'[name="'+r+'"]',function(){var i=s.val(),o=[];$.each(i||[],function(){isNaN(parseInt(this))?Array.prototype.push.apply(o,c[this]):Array.prototype.push.apply(o,c[parseInt(this)])}),t.field.choices=[],$.each(p,function(){o.indexOf(""+this[0])>-1&&t.field.choices.push(this)}),e.update(),$.fn.multiselect&&l.multiselect("rebuild")})}load("ui.bootstrap.multiselect",function(){var i=$("[name="+t.field.name+"]",e.root).multiselect(o);t.data[t.field.name]&&i.multiselect("select",t.data[t.field.name])})}else if("date"==t.type){var o=$.extend({},{format:"YYYY-MM-DD",showTime:!1,i18n:i},t.field.options);load("ui.pikaday",function(){$("[name="+t.field.name+"]").pikaday(o)})}else if("datetime"==t.type){var o=$.extend({},{format:"YYYY-MM-DD HH:mm:ss",showTime:!0,use24hour:!0,i18n:i},t.field.options);load("ui.pikaday",function(){$("[name="+t.field.name+"]").pikaday(o)})}t.data[t.field.name]&&("select"==t.type||"string"==typeof t.data[t.field.name]?$("[name="+t.field.name+"]").val(t.data[t.field.name]):($($("[name="+t.field.name+"]")[0]).val(t.data[t.field.name][0]),$($("[name="+t.field.name+"]")[1]).val(t.data[t.field.name][1])))}),this.get_placeholder=function(t,e){return e=void 0===e?0:e,Array.isArray(t)?t[e]:t}});